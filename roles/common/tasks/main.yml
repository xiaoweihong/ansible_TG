---

- include: prepare/mount.yml
  tags: [mount_check]
  when: not update

- include: bigtoe/bigtoe.yml
  tags: [bigtoe]
  when: not update

- include: prepare/directory_prepare.yml
  tags: [directory]
  when: not update

- include: prepare/software_prepare.yml
  tags: [software]
  when: not update

- name: Check vsftpd
  command: dpkg-query -l vsftpd
  register: vsftpd_check
  ignore_errors: True
  tags: [ftp]

- include: software/ftp.yml
  when: vsftpd_check.stderr.find('no packages found') != -1
  tags: [ftp]

- include: software/install_software.yml
  when: not update

#- include: install/installTG.yml

- name: Check SSH Version
  command: ssh -V
  register: SSH_check
  ignore_errors: True

- name: change ip for config file and change template file
  template:
    src: '{{ item.src }}'
    dest: '{{ item.dest }}'
  with_items:
    - { src: 'conf/bigtoe/DeepEngine-{{bigtoe_version}}.ini',dest: '/opt/bigtoe/DeepEngine-{{bigtoe_version}}.ini'}
    - { src: 'conf/bigtoe/DeepEngine-{{bigtoe_version}}.ini-template',dest: '/opt/bigtoe/src/var/www/bigtoe/tmpl/configs/DeepEngine-{{bigtoe_version}}'}
#    - { src: 'conf/link/link-configmap.yaml',dest: '/opt/bigtoe/pkg/k8s-conf/deepengine/link' }

#- include: bigtoe/updateImporter.yml

- name: config limits.conf
  copy:
    src: conf/limits/limits.conf
    dest: /etc/security/limits.conf

- name: config 90-nproc.conf
  copy:
    src: conf/limits/90-nproc.conf
    dest: /etc/security/limits.d/90-nproc.conf

- name: config sysctl.conf
  copy:
    src: conf/limits/sysctl.conf
    dest: /etc/sysctl.conf

- name: update SSH
  #debug: msg={{SSH_check}}
  include: software/updateSSH.yml
  when: SSH_check.stderr.find('OpenSSH_8.0p1') == -1
